---
/**
 * Testimonial Card Component
 *
 * Features:
 * - Filled background (accent-50) styling
 * - FTC compliant (Google-verified reviews only)
 * - HIPAA safe (no patient health info)
 * - Star rating display
 * - Dark/Light mode support
 * - Responsive design
 *
 * @example
 * <TestimonialCard
 *   id="review-1"
 *   author="John D."
 *   rating={5}
 *   text="Best dental experience I've ever had!"
 *   date="2024-12-15"
 *   verified={true}
 *   source="Google"
 * />
 */

export interface Props {
  /** Unique identifier */
  id: string;
  /** Reviewer name (first name + last initial for privacy) */
  author: string;
  /** Star rating 1-5 */
  rating: number;
  /** Review text */
  text: string;
  /** Review date (ISO string) */
  date?: string;
  /** Whether review is verified */
  verified?: boolean;
  /** Review source (Google, Yelp, etc.) */
  source?: string;
  /** Service received (optional, public info only) */
  service?: string;
}

const {
  id,
  author,
  rating,
  text,
  date,
  verified = false,
  source = "Google",
  service,
} = Astro.props;

// Format date for display
const formattedDate = date
  ? new Date(date).toLocaleDateString("en-US", { month: "short", year: "numeric" })
  : null;

// Clamp rating between 1-5
const stars = Math.min(5, Math.max(1, Math.round(rating)));
---

<article id={`testimonial-${id}`} class="testimonial-card">
  <!-- Quote Icon -->
  <div class="quote-icon" aria-hidden="true">
    <svg class="quote-svg" fill="currentColor" viewBox="0 0 24 24">
      <use href="#icon-quote" />
    </svg>
  </div>

  <!-- Star Rating -->
  <div class="star-rating" aria-label={`${stars} out of 5 stars`}>
    {
      Array.from({ length: 5 }).map((_, i) => (
        <svg
          class:list={["star", i < stars ? "star-filled" : "star-empty"]}
          fill="currentColor"
          viewBox="0 0 20 20"
          aria-hidden="true"
        >
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      ))
    }
  </div>

  <!-- Review Text -->
  <blockquote class="review-text">
    <p class="review-content">"{text}"</p>
  </blockquote>

  <!-- Service Tag (if provided) -->
  {
    service && (
      <div class="service-tag-container">
        <span class="service-tag">{service}</span>
      </div>
    )
  }

  <!-- Author & Meta -->
  <footer class="review-footer">
    <div class="author-info">
      <!-- Avatar placeholder -->
      <div class="avatar">
        <span class="avatar-initial">{author.charAt(0).toUpperCase()}</span>
      </div>
      <div class="author-details">
        <p class="author-name">{author}</p>
        {formattedDate && <p class="review-date">{formattedDate}</p>}
      </div>
    </div>

    <!-- Verified Badge -->
    {
      verified && (
        <div class="verified-badge">
          <svg class="verified-icon" fill="currentColor" viewBox="0 0 20 20">
            <use href="#icon-verified" />
          </svg>
          <span class="verified-text">Verified {source} Review</span>
        </div>
      )
    }
  </footer>
</article>

<style>
  .testimonial-card {
    position: relative;
    height: 100%;
    padding: 1.25rem;
    border-radius: var(--radius-lg);
    background: var(--color-surface-elevated);
    border: 1px solid var(--color-border);
    transition: all 0.3s ease-out;

    &:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--color-border-strong);
    }
  }

  /* Quote Icon */
  .quote-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    opacity: 0.1;
  }

  .quote-svg {
    width: 2rem;
    height: 2rem;
    color: var(--color-accent);
  }

  /* Star Rating */
  .star-rating {
    display: flex;
    align-items: center;
    gap: 0.125rem;
    margin-bottom: 0.75rem;
  }

  .star {
    width: 1rem;
    height: 1rem;
  }

  .star-filled {
    color: var(--color-accent);
  }

  .star-empty {
    color: var(--color-border);
  }

  /* Review Text */
  .review-text {
    margin: 0 0 0.75rem 0;
  }

  .review-content {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    line-height: var(--line-height-relaxed);
    font-style: italic;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Service Tag */
  .service-tag-container {
    margin-bottom: 0.75rem;
  }

  .service-tag {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    font-size: 0.625rem;
    border-radius: 9999px;
    background: color-mix(in srgb, var(--color-primary) 10%, transparent);
    color: var(--color-primary);
    border: 1px solid color-mix(in srgb, var(--color-primary) 20%, transparent);
  }

  /* Footer */
  .review-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 9999px;
    background: var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .avatar-initial {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-inverted);
  }

  .author-details {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .author-name {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
    margin: 0;
  }

  .review-date {
    font-size: 0.625rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Verified Badge */
  .verified-badge {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--color-success);
  }

  .verified-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  .verified-text {
    font-size: 0.625rem;
  }

  /* Responsive: Tablet (640px+) */
  @media (min-width: 640px) {
    .testimonial-card {
      padding: 1.5rem;
      border-radius: var(--radius-xl);
    }

    .quote-svg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .star-rating {
      gap: 0.1875rem;
      margin-bottom: 1rem;
    }

    .star {
      width: 1.125rem;
      height: 1.125rem;
    }

    .review-text {
      margin-bottom: 1rem;
    }

    .review-content {
      font-size: var(--font-size-base);
      -webkit-line-clamp: 4;
    }

    .service-tag-container {
      margin-bottom: 1rem;
    }

    .service-tag {
      padding: 0.1875rem 0.625rem;
      font-size: var(--font-size-xs);
    }

    .avatar {
      width: 2.5rem;
      height: 2.5rem;
    }

    .avatar-initial {
      font-size: var(--font-size-sm);
    }

    .author-name {
      font-size: var(--font-size-sm);
    }

    .review-date {
      font-size: var(--font-size-xs);
    }

    .verified-icon {
      width: 1rem;
      height: 1rem;
    }

    .verified-text {
      font-size: var(--font-size-xs);
    }
  }

  /* Responsive: Desktop (1024px+) */
  @media (min-width: 1024px) {
    .testimonial-card {
      padding: 2rem;
    }

    .quote-svg {
      width: 3rem;
      height: 3rem;
    }

    .star {
      width: 1.25rem;
      height: 1.25rem;
    }

    .star-rating {
      gap: 0.25rem;
    }

    .review-content {
      -webkit-line-clamp: unset;
    }
  }

</style>
